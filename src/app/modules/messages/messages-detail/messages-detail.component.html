<div class="wrapper" *ngIf="conversation else notfoundtemplate">
  <div nz-row class="header">
    <nz-list-item>
      <nz-list-item-meta [nzTitle]="titleTemplate" [nzAvatar]="avatarTemplate" [nzDescription]="descriptionTemplate">
        <ng-template #titleTemplate>
          <a class="title">{{partner?.first_name || "noname"}}</a>
        </ng-template>
        <ng-template #avatarTemplate>
          <nz-avatar [nzSize]="48" nzIcon="user" [nzSrc]="partner?.image"></nz-avatar>
        </ng-template>
        <ng-template #descriptionTemplate>
          <span>{{conversation.title}}</span>
        </ng-template>
      </nz-list-item-meta>
    </nz-list-item>
  </div>

  <!-- msgs -->
  <div nz-row class="conversation-wrapper">
    <div nz-col class="conversation" nzSpan="24">
      <div nz-row class="conversation-messages" #conversationMessages>
        <div nz-col>
          <div *ngIf="!messages || !messages.next" nz-row style="text-align: center;">
            <small>conversation start</small>
          </div>

          <div *ngIf="messages && messages.next" (click)="loadMore()" nz-row style="text-align: center;">
            <small><a>Зареди повече</a></small>
          </div>
          <div *ngFor="let msg of messages?.results; trackBy: trackIdentifyByItemId; let i = index"
            [class.right]="msg.author.id == this.userService.currentUser.id" class="message" [class.same-author]="isLastAuthorMessage(i)" nz-row
            nzType="flex" nzJustify="start" nzAlign="bottom">
            <div nz-col class="message-author">
              <!-- TODO: routerlink -->
              <nz-avatar *ngIf="isLastAuthorMessage(i)" [nzSize]="32" nzIcon="user"
                [nzSrc]="msg.author.image"></nz-avatar>
            </div>
            <div nz-col class="message-content">
              <span class="message-text">{{msg.text}}</span>
              <!-- images TODO -->
              <div class="message-images-list">
                <div nz-row nzType="flex" nzGutter="16">
                  <div class="image-list-item" nz-col *ngFor="let image of msg.images; let index=index;" (click)="setZoomImages(msg.images, index)">
                    <nz-avatar [nzSize]="50" nzShape="square" [nzSrc]="image.image">
                    </nz-avatar>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <app-new-message-form class="conversation-input" (onNewMessage)="appendNewMessage($event)" [conversation]="conversation"></app-new-message-form>
    </div>
  </div>
</div>

<app-carousel *ngIf="zoomImages?.length > 0" (onZoomClose)="setZoomImages(null)" [imageIndex]="zoomImagesIdx" [images]="zoomImages" [zoomOnly]="true"></app-carousel>

<ng-template #notfoundtemplate>
  <div nz-row nzJustify="center" nzType="flex">
    <h2>Conversation not found</h2>
    <app-page-not-found></app-page-not-found>
  </div>
</ng-template>
